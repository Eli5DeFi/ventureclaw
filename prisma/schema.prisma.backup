// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// Authentication (NextAuth.js)
// ============================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // hashed password for credentials login
  walletAddress String?   @unique // Web3 wallet address
  
  // Subscription
  tier          String    @default("free") // "free" | "startup" | "enterprise"
  apiKey        String?   @unique
  stripeCustomerId String?
  
  // Relations
  accounts      Account[]
  sessions      Session[]
  startups      Startup[] // User's pitches
  memories      Memory[]
  memorySearches MemorySearch[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([email])
  @@index([apiKey])
  @@index([walletAddress])
}

model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

// ============================================
// Core Models
// ============================================

model Startup {
  id            String   @id @default(cuid())
  userId        String?  // Link to user who submitted this
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  name          String
  tagline       String
  description   String
  stage         Stage
  industry      String
  fundingAsk    Int
  teamSize      Int
  founderName   String
  founderEmail  String
  website       String?
  deckUrl       String?
  pitchVideo    String?
  
  status        StartupStatus @default(PENDING)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  analysis      Analysis?
  vcMatches     VCMatch[]
  messages      Message[]
  coachingSessions CoachingSession[]
  marketingCampaigns MarketingCampaign[]
  agentActivities AgentActivity[]
  funding       Funding?  // Accepted funding deal
  memories      Memory[]
  
  @@index([status])
  @@index([createdAt])
  @@index([userId])
}

model Analysis {
  id            String   @id @default(cuid())
  startupId     String   @unique
  startup       Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)
  
  // Individual agent scores
  financialScore    Int
  technicalScore    Int
  marketScore       Int
  legalScore        Int
  overallScore      Int
  
  // Detailed feedback (JSON)
  financialFeedback  Json
  technicalFeedback  Json
  marketFeedback     Json
  legalFeedback      Json
  
  // Results
  valuation         Int
  recommendation    Recommendation
  summary           String
  
  // Investment offers generated from this analysis
  offersGenerated   Json?    // Array of offer objects, will migrate to InvestmentOffer table when PostgreSQL is set up
  
  // Metadata
  analysisStartedAt DateTime
  analysisCompletedAt DateTime?
  analysisDuration  Int? // seconds
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([recommendation])
}

// ============================================
// Funding & Milestones
// ============================================

model Funding {
  id              String   @id @default(cuid())
  startupId       String   @unique
  startup         Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)
  
  dealAmount      Int      // in USD cents
  equityPercent   Float
  dealType        String   // "SAFE", "Equity", "Convertible"
  acceptedAt      DateTime
  
  milestones      Milestone[]
  totalReleased   Int      @default(0)
  status          String   @default("active") // active, completed, defaulted
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([status])
}

model Milestone {
  id          String    @id @default(cuid())
  fundingId   String
  funding     Funding   @relation(fields: [fundingId], references: [id], onDelete: Cascade)
  
  number      Int       // 1-5
  description String
  amount      Int       // in USD cents
  dueDate     DateTime
  status      String    @default("pending") // pending, completed, verified
  txHash      String?   // On-chain verification
  completedAt DateTime?
  verifiedAt  DateTime?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  @@index([fundingId])
  @@index([status])
}

model VCMatch {
  id          String   @id @default(cuid())
  startupId   String
  startup     Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)
  vcId        String
  vc          VC       @relation(fields: [vcId], references: [id], onDelete: Cascade)
  
  interested      Boolean @default(false)
  interestLevel   Int // 0-100
  feedback        String?
  
  // VC persona agent response
  personaResponse Json?
  
  status          MatchStatus @default(PENDING)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([startupId, vcId])
  @@index([status])
}

model VC {
  id            String   @id @default(cuid())
  name          String
  firmName      String
  email         String   @unique
  fundSize      String
  focusAreas    String[] // Array of industries
  stagePreference String[] // Array of stages
  
  investmentRangeMin  Int
  investmentRangeMax  Int
  
  thesis        String
  portfolio     String[] // Company names or URLs
  
  // AI Persona
  personaName   String?
  personaPersonality String?
  personaStyle  String?
  riskTolerance RiskTolerance @default(MODERATE)
  priorities    String[] // What the persona values most
  
  // OpenAI Assistant ID for the persona
  assistantId   String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  matches       VCMatch[]
  
  @@index([firmName])
}

// ============================================
// Coaching & Mentorship
// ============================================

model CoachingSession {
  id          String   @id @default(cuid())
  startupId   String
  startup     Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)
  
  agentType   AgentType
  threadId    String?  // OpenAI thread ID for persistent conversations
  
  messages    Json[]
  actionItems Json[]
  
  nextCheckIn DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([startupId, agentType])
}

model Message {
  id          String   @id @default(cuid())
  startupId   String
  startup     Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)
  
  role        MessageRole
  content     String
  agentType   AgentType?
  
  metadata    Json?
  
  createdAt   DateTime @default(now())
  
  @@index([startupId, createdAt])
}

// ============================================
// Marketing Automation
// ============================================

model MarketingCampaign {
  id          String   @id @default(cuid())
  startupId   String
  startup     Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)
  
  type        CampaignType
  status      CampaignStatus @default(DRAFT)
  
  title       String
  description String?
  
  content     Json // Campaign-specific content
  schedule    Json? // Publishing schedule
  metrics     Json? // Performance metrics
  
  startDate   DateTime?
  endDate     DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedAt DateTime?
  
  @@index([startupId, status])
}

// ============================================
// Agent Activity Tracking
// ============================================

model AgentActivity {
  id          String   @id @default(cuid())
  startupId   String?
  startup     Startup? @relation(fields: [startupId], references: [id], onDelete: Cascade)
  
  agentName   String
  agentType   AgentType
  action      String
  description String
  
  status      ActivityStatus @default(RUNNING)
  result      String?
  errorMessage String?
  
  metadata    Json?
  
  startedAt   DateTime @default(now())
  completedAt DateTime?
  duration    Int? // milliseconds
  
  @@index([startupId, agentType])
  @@index([status])
  @@index([startedAt])
}

// ============================================
// Waitlist & Marketing
// ============================================

model WaitlistEntry {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String?
  role        String?  // "founder" | "vc" | "other"
  referredBy  String?
  utmSource   String?
  utmMedium   String?
  utmCampaign String?
  
  createdAt   DateTime @default(now())
  
  @@index([email])
  @@index([createdAt])
}

// ============================================
// M&A / Exit Accelerator
// ============================================

model ExitAnalysis {
  id              String   @id @default(cuid())
  
  // Company info
  companyName     String
  industry        String
  stage           String
  revenue         Int
  
  // Analysis results
  status          ExitStatus @default(ANALYZING)
  
  valuationLow    Int?
  valuationBase   Int?
  valuationHigh   Int?
  
  readinessScore  Int? // 0-100
  recommendation  String?
  
  // Acquirer matches
  topAcquirers    String[] // Top 10 acquirer names
  
  // Full report (JSON)
  fullReport      Json?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  completedAt     DateTime?
  
  @@index([status])
  @@index([createdAt])
}

enum ExitStatus {
  ANALYZING
  COMPLETE
  FAILED
}

// ============================================
// Matching Engine - Primary + Secondary Markets
// ============================================

model Project {
  id              String   @id @default(cuid())
  
  // Basic info
  name            String
  tagline         String
  description     String
  industry        String
  stage           String
  
  // Fundraising
  fundingType     FundingType
  amountSeeking   Int
  valuation       Int?
  tokenPrice      Float?
  minTicketSize   Int
  maxTicketSize   Int
  
  // Financials
  revenue         Int
  revenueGrowth   Int
  customers       Int
  teamSize        Int
  
  // Qualitative
  problem         String
  solution        String
  traction        String
  moat            String
  
  // Geography
  geography       String[]
  
  // AI-generated profile
  investmentThesis String?
  keyRisks        String[]
  keyOpportunities String[]
  comparables     String[]
  exitScenarios   String[]
  
  // Matching
  idealInvestorTypes String[]
  matches         Match[]
  
  // Status
  status          ProjectStatus @default(OPEN)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  closedAt        DateTime?
  
  @@index([status])
  @@index([industry])
  @@index([fundingType])
}

model Investor {
  id              String   @id @default(cuid())
  
  name            String
  email           String   @unique
  type            InvestorType
  
  // Criteria
  focusAreas      String[]
  stagePreference String[]
  checkSizeMin    Int
  checkSizeMax    Int
  geography       String[]
  fundingTypes    FundingType[]
  
  // Preferences
  riskTolerance   RiskTolerance
  timeHorizon     String
  investmentThesis String
  priorities      String[]
  dealBreakers    String[]
  
  // Portfolio
  portfolioCompanies String[]
  
  // Matching
  matches         Match[]
  
  active          Boolean @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([type])
  @@index([active])
}

model Match {
  id              String   @id @default(cuid())
  
  projectId       String
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  investorId      String
  investor        Investor @relation(fields: [investorId], references: [id], onDelete: Cascade)
  
  // Match quality
  overallScore    Int // 0-100
  industryFit     Int
  stageFit        Int
  ticketSizeFit   Int
  geographyFit    Int
  fundingTypeFit  Int
  thesisFit       Int
  
  // Analysis
  reasoning       String
  synergies       String[]
  concerns        String[]
  
  // Status
  status          MatchStatus @default(PENDING)
  
  // Interaction
  investorViewed  Boolean @default(false)
  investorInterested Boolean @default(false)
  projectViewed   Boolean @default(false)
  
  // Meeting
  meetingScheduled DateTime?
  meetingNotes    String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([projectId, investorId])
  @@index([status])
  @@index([overallScore])
}

// OTC / Secondary Market

model Asset {
  id              String   @id @default(cuid())
  
  symbol          String   @unique
  name            String
  type            AssetType
  companyId       String?
  
  // Supply
  totalSupply     Int?
  circulatingSupply Int?
  
  // Token-specific
  contractAddress String?
  chainId         Int?
  
  // Restrictions
  accreditedOnly  Boolean @default(false)
  lockupPeriod    Int? // days
  transferRestrictions String?
  
  active          Boolean @default(true)
  
  orders          Order[]
  trades          Trade[]
  
  createdAt       DateTime @default(now())
  
  @@index([symbol])
  @@index([type])
}

model Order {
  id              String   @id @default(cuid())
  
  assetId         String
  asset           Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  userId          String
  
  side            OrderSide
  orderType       OrderType
  
  quantity        Float
  price           Float?
  
  minQuantity     Float?
  maxQuantity     Float?
  
  status          OrderStatus @default(OPEN)
  filledQuantity  Float @default(0)
  
  isPublic        Boolean @default(true)
  
  expiresAt       DateTime?
  
  buyTrades       Trade[] @relation("BuyOrders")
  sellTrades      Trade[] @relation("SellOrders")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([assetId, status])
  @@index([userId])
}

model Trade {
  id              String   @id @default(cuid())
  
  assetId         String
  asset           Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  buyOrderId      String
  buyOrder        Order    @relation("BuyOrders", fields: [buyOrderId], references: [id])
  
  sellOrderId     String
  sellOrder       Order    @relation("SellOrders", fields: [sellOrderId], references: [id])
  
  buyerId         String
  sellerId        String
  
  quantity        Float
  price           Float
  totalValue      Float
  
  settlementStatus SettlementStatus @default(PENDING)
  settlementMethod SettlementMethod
  settlementTxHash String?
  
  buyerFee        Float
  sellerFee       Float
  
  executedAt      DateTime @default(now())
  settledAt       DateTime?
  
  @@index([assetId])
  @@index([buyerId])
  @@index([sellerId])
  @@index([executedAt])
}

// ============================================
// Matching Engine Enums
// ============================================

enum FundingType {
  EQUITY
  TOKEN
  SAFE
  DEBT
  REVENUE_SHARE
}

enum InvestorType {
  VC
  ANGEL
  FAMILY_OFFICE
  INSTITUTIONAL
  RETAIL
  DAO
}

enum ProjectStatus {
  OPEN
  FUNDED
  CLOSED
  CANCELLED
}

enum AssetType {
  EQUITY
  TOKEN
  SAFE
  DEBT
  WARRANT
}

enum OrderSide {
  BUY
  SELL
}

enum OrderType {
  MARKET
  LIMIT
  RFI
}

enum OrderStatus {
  OPEN
  PARTIAL
  FILLED
  CANCELLED
  EXPIRED
}

enum SettlementStatus {
  PENDING
  SETTLED
  FAILED
}

enum SettlementMethod {
  ON_CHAIN
  ESCROW
  MANUAL
}

// ============================================
// Semantic Memory System
// ============================================

model Memory {
  id              String   @id @default(cuid())
  
  content         String   // The actual memory text
  embedding       String?  // JSON array of embedding vector
  
  memoryType      String   @default("evaluation") // evaluation, pattern, insight, lesson
  
  // Entity linking
  entityId        String?  // ID of related entity (startupId, analysisId, etc.)
  entityType      String?  // "startup", "analysis", "agent", "decision"
  
  // Context
  userId          String?
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  startupId       String?
  startup         Startup? @relation(fields: [startupId], references: [id], onDelete: SetNull)
  
  metadata        Json?    // Additional context (agent name, scores, tags, etc.)
  
  // Retrieval optimization
  relevanceScore  Float?   // Weighted score for ranking
  accessCount     Int      @default(0)
  lastAccessedAt  DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([memoryType])
  @@index([entityId, entityType])
  @@index([userId])
  @@index([startupId])
  @@index([createdAt])
  @@index([relevanceScore])
}

model MemorySearch {
  id              String   @id @default(cuid())
  
  query           String   // Search query text
  queryEmbedding  String?  // JSON array of query embedding
  
  resultCount     Int      @default(0)
  topResultIds    String[] // IDs of top matching memories
  averageScore    Float?   // Average similarity score
  
  context         Json?    // Context at search time
  
  userId          String?
  user            User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  createdAt       DateTime @default(now())
  
  @@index([userId])
  @@index([createdAt])
}

// ============================================
// Enums
// ============================================

enum Stage {
  IDEA
  MVP
  GROWTH
  SCALE
}

enum StartupStatus {
  PENDING
  ANALYZING
  APPROVED
  CONDITIONAL
  REJECTED
  FUNDED
}

enum Recommendation {
  APPROVED
  CONDITIONAL
  REJECTED
}

enum MatchStatus {
  PENDING
  INTERESTED
  PASSED
  MEETING_SCHEDULED
  TERM_SHEET
  CLOSED
}

enum RiskTolerance {
  CONSERVATIVE
  MODERATE
  AGGRESSIVE
}

enum AgentType {
  FINANCIAL_ANALYST
  TECHNICAL_DD
  MARKET_RESEARCH
  LEGAL_COMPLIANCE
  VC_MATCHING
  SYNTHESIS
  
  STRATEGIC_ADVISOR
  PRODUCT_COACH
  SALES_COACH
  FUNDRAISING_COACH
  MENTAL_HEALTH_COACH
  TECHNICAL_ADVISOR
  
  CONTENT_STRATEGY
  CONTENT_CREATOR
  DISTRIBUTION
  SEO
  GROWTH_HACKING
  ANALYTICS
  
  FUNDING_ALLOCATION
  PORTFOLIO_MANAGEMENT
  NETWORK_CONNECTOR
  COMPLIANCE
  
  COPILOT
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum CampaignType {
  CONTENT
  SOCIAL
  EMAIL
  SEO
  PAID_ADS
  PR
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  RUNNING
  PAUSED
  COMPLETED
  CANCELLED
}

enum ActivityStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}
